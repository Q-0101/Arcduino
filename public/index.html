<!DOCTYPE html>
<html>
<head>
  <title>Water Sensor Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

  <style>
    body {
      font-family: Arial;
      margin: 20px;
      background-color: #131722;
      color: #e0e0e0;
    }

    h1 {
      color: #ffffff;
      text-align: center;
      margin-bottom: 10px;
    }

    .top-bar {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 15px;
      align-items: center;
    }

    button {
      padding: 8px 14px;
      font-size: 14px;
      border-radius: 5px;
      border: none;
      cursor: pointer;
      background: #2563eb;
      color: white;
    }

    button:hover { background: #1d4ed8; }

    .status {
      font-size: 13px;
      color: #bbbbbb;
    }

    .container {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }

    .main-chart {
      flex: 3;
      height: 600px;
    }

    .side-charts {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .side-charts > div {
      height: 100px;
      margin-bottom: 10px;
    }

    canvas {
      background: #1e2330;
      padding: 10px;
      border-radius: 8px;
      width: 100%;
      height: 100%;
    }

    .chart-title {
      text-align: center;
      font-size: 14px;
      margin-bottom: 5px;
      color: #ffffff;
    }
  </style>
</head>
<body>

<h1>Water Sensor Dashboard</h1>

<div class="top-bar">
  <button onclick="requestNotificationPermission()">ðŸ”” Enable Alerts</button>
  <div class="status" id="notifStatus">Notifications: unknown</div>
</div>

<div class="container">
  <div class="main-chart">
    <canvas id="waterChart"></canvas>
  </div>

  <div class="side-charts">
    <div><div class="chart-title">1 Day</div><canvas id="chart1Day"></canvas></div>
    <div><div class="chart-title">3 Days</div><canvas id="chart3Days"></canvas></div>
    <div><div class="chart-title">1 Week</div><canvas id="chart1Week"></canvas></div>
    <div><div class="chart-title">1 Month</div><canvas id="chart1Month"></canvas></div>
    <div><div class="chart-title">1 Year</div><canvas id="chart1Year"></canvas></div>
  </div>
</div>

<script>
/* ===========================
   NOTIFICATIONS
=========================== */
const ALERT_LEVEL = 500;
let notified = false;
const notifStatus = document.getElementById("notifStatus");

function updateNotifStatus() {
  notifStatus.textContent = "Notifications: " + Notification.permission;
}

async function requestNotificationPermission() {
  await Notification.requestPermission();
  updateNotifStatus();
}

updateNotifStatus();

/* ===========================
   MAIN CHART
=========================== */
const waterChart = new Chart(
  document.getElementById('waterChart'),
  {
    type: 'line',
    data: {
      datasets: [{
        label: 'Water Level',
        data: [],
        borderColor: '#4cafeb',
        tension: 0,
        pointRadius: 3,
        pointHoverRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      scales: {
        x: { type: 'time', grid: { drawTicks: false } },
        y: { grid: { color: '#2a2e3b' } }
      }
    },
    plugins: [{
      id: 'thresholdLine',
      afterDraw: chart => {
        const y = chart.scales.y.getPixelForValue(ALERT_LEVEL);
        const ctx = chart.ctx;
        ctx.save();
        ctx.setLineDash([6,4]);
        ctx.strokeStyle = 'red';
        ctx.beginPath();
        ctx.moveTo(chart.chartArea.left, y);
        ctx.lineTo(chart.chartArea.right, y);
        ctx.stroke();
        ctx.restore();
      }
    }]
  }
);

/* ===========================
   SMALL CHART FACTORY
=========================== */
function createSmallChart(id, unit) {
  return new Chart(document.getElementById(id), {
    type: 'line',
    data: { datasets: [{ data: [], borderColor: '#4cafeb', pointRadius: 2, tension: 0.35 }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { type: 'time', time: { unit }, display: false },
        y: { grid: { color: '#2a2e3b' } }
      }
    }
  });
}

const chart1Day   = createSmallChart('chart1Day', 'hour');
const chart3Days  = createSmallChart('chart3Days', 'day');
const chart1Week  = createSmallChart('chart1Week', 'day');
const chart1Month = createSmallChart('chart1Month', 'day');
const chart1Year  = createSmallChart('chart1Year', 'month');

/* ===========================
   DATA GROUPING
=========================== */
function groupData(data, days, unit) {
  const now = Date.now();
  const buckets = new Map();

  data.forEach(d => {
    const t = new Date(d.timestamp);
    if ((now - t) / 86400000 > days) return;

    let key;
    if (unit === 'hour') key = new Date(t.getFullYear(), t.getMonth(), t.getDate(), t.getHours());
    else if (unit === 'day') key = new Date(t.getFullYear(), t.getMonth(), t.getDate());
    else key = new Date(t.getFullYear(), t.getMonth(), 1);

    if (!buckets.has(+key)) buckets.set(+key, []);
    buckets.get(+key).push(d.level);
  });

  return [...buckets.entries()].map(([x, arr]) => ({
    x: new Date(+x),
    y: arr.reduce((a,b)=>a+b)/arr.length
  }));
}

/* ===========================
   FETCH + UPDATE (1 SECOND)
=========================== */
async function fetchData() {
  const res = await fetch('/api/water-level');
  const data = await res.json();

  const recent = data.slice(-100);
  waterChart.data.datasets[0].data =
    recent.map(d => ({ x: new Date(d.timestamp), y: d.level }));
  waterChart.update('none');

  chart1Day.data.datasets[0].data   = groupData(data, 1, 'hour');
  chart3Days.data.datasets[0].data = groupData(data, 3, 'day');
  chart1Week.data.datasets[0].data = groupData(data, 7, 'day');
  chart1Month.data.datasets[0].data= groupData(data, 30, 'day');
  chart1Year.data.datasets[0].data = groupData(data, 365, 'month');

  chart1Day.update('none');
  chart3Days.update('none');
  chart1Week.update('none');
  chart1Month.update('none');
  chart1Year.update('none');

  const latest = recent.at(-1);
  if (!latest) return;

  if (latest.level > ALERT_LEVEL && !notified && Notification.permission === "granted") {
    new Notification("âš  Water Level Alert", { body: `Level is ${latest.level}` });
    notified = true;
  }
  if (latest.level <= ALERT_LEVEL) notified = false;
}

setInterval(fetchData, 1000);
fetchData();
</script>

</body>
</html>
